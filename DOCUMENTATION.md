# 📚 Documentation: AI-Powered Outlook Email Automation with n8n

This document provides a detailed technical breakdown and instructions to deploy and manage the AI-powered Outlook email automation system using n8n, Microsoft Graph API, and LLMs like Google Gemini or OpenAI.

---

## 🔧 System Overview

**Goal**: Automate email replies using an AI assistant, with approval workflows integrated in Microsoft Teams.

**Core Stack**:
- **n8n** (Self-hosted automation platform)
- **Docker** (Deployment)
- **Nginx** (Reverse Proxy)
- **Microsoft Graph API** (Outlook + Teams integration)
- **Google Gemini / OpenAI** (LLM-based email replies)
- **Cloudflare** (SSL + DNS)

---

## 🔐 Security & Hosting

- Self-hosted using Docker on your VPS
- All traffic routed via **Cloudflare with Full SSL (Strict)**
- OAuth2 used for authenticating with Microsoft APIs

---

## 📝 Setup Summary

### 1. Server and Domain
- Setup A record for `n8n.yourdomain.com`
- Ensure DNS is managed by **Cloudflare**
- SSL/TLS setting: `Full` or `Full (Strict)`

### 2. Docker Deployment
```bash
mkdir n8n-automation && cd n8n-automation
docker-compose up -d
```

Use the provided `docker-compose.yml` file to configure:
- Webhook
- Custom domain
- Memory limits
- Timezone

### 3. Reverse Proxy (Nginx)
Create `/etc/nginx/sites-available/n8n.conf`:
```nginx
server {
    listen 80;
    server_name n8n.yourdomain.com;
    location / {
        proxy_pass http://localhost:5678;
        proxy_set_header Host $host;
        ...
    }
}
```
Then:
```bash
sudo ln -s /etc/nginx/sites-available/n8n.conf /etc/nginx/sites-enabled/
sudo nginx -t && sudo systemctl restart nginx
```

---

## 🛡 Microsoft Azure App Registration

1. Go to https://portal.azure.com
2. Register App under Microsoft Entra ID → App Registrations
3. Use redirect URI: `https://n8n.yourdomain.com/rest/oauth2-credential/callback`
4. Get:
   - Client ID
   - Client Secret
5. Permissions (Delegated):
   - `Mail.ReadWrite`
   - `Mail.Send`
   - `User.Read`
   - `offline_access`
6. Grant admin consent

---

## 🔁 Workflow Logic

### Workflow 1: `Outlook_Email_Draft_Teams_Alert`
- Trigger: Microsoft Outlook (new unread email)
- Get email content
- Generate reply using LLM (Gemini/OpenAI)
- Create reply draft via Graph API
- Send Adaptive Card to Teams with `✅ Accept & Send` and `✏️ Edit in Outlook`

### Workflow 2: `Outlook_Email_Create_Send`
- Triggered by Teams webhook
- Extract draftId
- Send draft via Graph API

---

## 🧠 Prompt Template (LLM)
```text
You are a professional and helpful business assistant. Please read the following email and write a clear, concise, and polite reply. Format the response in HTML with proper <p> tags.

Subject: {{ $node["Microsoft Outlook Trigger"].json.subject }}
From: {{ $node["Microsoft Outlook Trigger"].json.from.emailAddress.address }}

Content:
{{ $node["Get Email Body"].json.body.content }}
```

---

## 💬 Microsoft Teams Adaptive Card Fields
- **From**: Sender's email
- **Subject**: Email subject
- **Received**: Timestamp
- **Draft**: HTML reply generated by AI
- **Buttons**:
  - ✅ Accept & Send (Calls Webhook)
  - ✏️ Edit in Outlook (Opens draft URL)

---

## 🔧 Configuration Files Reference
- `docker-compose.yml`: Manages n8n container config
- `nginx.conf`: HTTP reverse proxy
- `.env` (optional): Use for secret management

---

## 🔒 Best Practices
- Always restrict `n8n` to internal ports (use Nginx only)
- Rotate Azure secrets every 6–12 months
- Enable 2FA on Microsoft and Cloudflare accounts

---

## 📎 Files
- `Outlook_Email_Draft_Teams_Alert.json`: Main logic
- `Outlook_Email_Create_Send.json`: Sends draft email on approval
- `docker-compose.yml`: Service config
- `nginx.conf`: Web proxy

---

---

## 🧩 Extending the Workflow
- Add database or Notion logging
- Slack integration
- Summarize conversations with AI before replying
- Add retry/error catch blocks for resilience

---

> Built with ❤️ and n8n + LLMs.
